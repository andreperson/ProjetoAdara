@model Domain.ModelView.UsuarioMenuSubModelView

@section Scripts {

    <script src="@Domain.Util.config.UrlSite/Scripts/jsmask/lib/jquery-1.8.3.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="@Domain.Util.config.UrlSite/Scripts/jsmask/dist/jquery.maskedinput.min.js" type="text/javascript"></script>
    <script src="@Domain.Util.config.UrlSite/Scripts/jqueryenterdesable.js" type="text/javascript"></script>

    <script type="text/javascript">

        //$('input:checkbox').change(function () {
        //    //tipoid
        //    if (this.checked == false) {
        //        var ckname = this.name;
        //        var tpindex = ckname.indexOf("&_")
        //        var tpid = this.name.substr(3, tpindex - 3);

        //        //menuid
        //        var mnid = this.name.substr(tpindex + 2, 10);

        //        if (mnid == "1") {
        //            this.checked = true;
        //        }

        //    }

        //});

        //*****************
        //valida o form
        $(document).submit(function (e) {
            e.preventDefault();
            var lista = [];
            var tpid = "";
            var tpindex = "";
            var mnid = "";
            var mnindex = "";
            var ckname = "";

            $.each($('input:checkbox'), function (i, el) {
                //pega o nome do controle
                ckname = el.name;

                //validações
                if (ckname.indexOf("ck_") >= 0) {
                    //tipoid
                    tpindex = ckname.indexOf("&_")
                    tpid = el.name.substr(3, tpindex - 3);

                    //menuid
                    quasemnid = el.name.substr(tpindex + 2, 10);

                    mnindex = quasemnid.indexOf("+_")

                    mnid = quasemnid.substr(0, mnindex);

                    tpindexsub = ckname.indexOf("+_")
                    //menusubid
                    sbid = el.name.substr(tpindexsub + 2, 10);



                    atvid = el.name.replace("ckat", "");
                    if (el.checked) {
                        lista.push(tpid + ":" + mnid + ":" + sbid)
                    }
                }
            });

            //submit form

            $.post('@Url.Action("InsertAjax")', $.param({ data: lista }, true), function (data) { });

            redir();
            //$.get('@Url.Action("InsertAjax")', $.param({ data: lista }, true), function (data) { });
        });


        function redir() {
            function explode() {

                var menuid = $("#Menuid").val();
                var menusubid = $("#UsuarioMenuSubid").val();

                var url = "/UserMeniSub/UsuarioMenuSub/" + menuid + "/" + menusubid + "/0";
                //alert(url);
                $(location).attr("href", url);
            }
            setTimeout(explode, 2000);
        }


        //**********************************************
        //fim submit



        //load
        $(document).ready(function () {
            //limpa os controles
            $.each($('input'), function (i, el) {
                el.checked = false;
            });

            //carrega os checks
            listaPersmissoes();
        });


        function listaPersmissoes() {
            $.getJSON('@Url.Action("ListaPermissoes/")', listaPermissoesCallBack);
        }

        function listaPermissoesCallBack(json) {
            var i = 0;
            var ckname = ""
            $.each(json, function (key, data) {
                $.each($('input:checkbox'), function (i, el) {
                    $.each(json, function (key, data) {
                        ckname = "ck_" + data.usuariotipoid + "&_" + data.menuid + "+_" + data.menusubid
                        if (el.name == ckname) {
                            el.checked = true;
                        }
                    })

                });
            })
        }


    </script>
}


@{
    ViewBag.Title = "Adarana";
}

@*<div id="MenuSub_tab">
    <a href="@Domain.Util.config.UrlSite/Meni/Menu" class="btn btn-sm btn-default btn-flat">Menu</a>
    <a href="@Domain.Util.config.UrlSite/User/Usuario" class="btn btn-sm btn-default btn-flat">Usuário</a>
    <a href="@Domain.Util.config.UrlSite/UserMeniSub/UsuarioMenuSub" class="btn btn-sm btn-default btn-flat">Permissão</a>
    <a href="@Domain.Util.config.UrlSite/UserType/UsuarioTipo" class="btn btn-sm btn-default btn-flat">Usuário Tipo</a>
</div>*@


@using (Html.BeginForm("UsuarioMenuSub", "UserMeniSub", FormMethod.Post, new { autocomplete = "on" }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)


    <div class="main-content">
        <div class="row">
            <!-- Left col -->
            <div class="col-md-12">
                <!-- TABLE: LATEST ORDERS -->
                <div class="box box-info">
                    <div class="box-header with-border">
                        <h3 class="box-title">Cadastros</h3>
                        <div class="box-tools pull-right">@Model.MenusSubs.Count Sub Menu(s) listado(s)</div>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body">
                        <div class="table-responsive">
                            <table class="table no-margin" id="ajax">
                                <thead>
                                    <tr>
                                        <th>Menu</th>
                                        <th>Sub Menu</th>
                                        <th>Permissões</th>
                                    </tr>
                                </thead>
                                @{
                                    var ultimomenu = string.Empty;
                                }
                                @foreach (var item in Model.MenusSubs)
                                {
                                    if (item.descricaomenu != ultimomenu)
                                    {
                                        var itemdescr = item.descricaomenu.Trim() + ".png";
                                        <tr><td colspan="10">&nbsp;</td></tr>
                                        <tr @*class="tablelist corp"*@ id="sumir" style="padding: 10px 10px 10px 10px !important">
                                            <td class="minimo" style="border-color: #f7f7f7">
                                                <img src="@Domain.Util.config.UrlImg/menu/ico-@itemdescr" width="50" />
                                            </td>
                                        </tr>
                                        //busca o submenu de acordo com o menu
                                    }
                                    <tr>
                                        <td>&nbsp;</td>
                                        <td class="grande">
                                            @item.descricao
                                        </td>

                                        @foreach (var tipoitem in Model.UsuariosTipos)
                                        {
                                            <td style="border-color: #f7f7f7">
                                                <input type="checkbox" id="ck_@tipoitem.usuariotipoid&_@item.menuid+_@item.menusubid" name="ck_@tipoitem.usuariotipoid&_@item.menuid+_@item.menusubid" />@tipoitem.descricao
                                            </td>
                                        }

                                    </tr>
                                    ultimomenu = item.descricaomenu;
                                }
                            </table>
                        </div>
                    </div>
                    <div class="box-footer clearfix">
                        <button name="button" class="botao01" value="register">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @Html.Hidden("UsuarioMenuSubid", Model.menusubid)
@Html.Hidden("Menuid", Model.menuid)

}


